---
# Create the .env file for secrets
- name: Create secrets file
  copy:
    content: |
      # Domain Configuration
      PRIMARY_DOMAIN={{ primary_domain }}
      TRAEFIK_DOMAIN={{ traefik_domain }}
      CRM_DOMAIN={{ crm_domain }}
      MAIL_DOMAIN={{ mail_domain }}
      PORTAINER_DOMAIN={{ portainer_domain }}
      TRAEFIK_EMAIL={{ traefik_email }}

      # Traefik Authentication (from COMPOSE_ENV)
      {{ lookup('env', 'COMPOSE_ENV') | default('') }}

      # Odoo Database Configuration
      ODOO_DB_USER=odoo
      ODOO_DB_PASSWORD=your_secure_password_here
      ODOO_DB_NAME=odoo
      ODOO_DB_PGDATA=/var/lib/postgresql/data

      # Mailu Configuration
      DOCKER_ORG=ghcr.io/mailu
      DOCKER_PREFIX=
      MAILU_VERSION=2024.06

      # Grafana Configuration
      DS_PROMETHEUS=prometheus
    dest: "{{ compose_path }}/.env"
    owner: "{{ sudo_user }}"
    group: "{{ sudo_user }}"
    mode: '0600'

- name: Tear down Docker Compose services
  ansible.builtin.command:
    cmd: docker-compose down
    chdir: "{{ compose_path }}/"

- name: Prune everything (including non-dangling images)
  community.docker.docker_prune:
    containers: yes
    images: yes
    images_filters:
      dangling: false
    networks: yes
    volumes: yes
    builder_cache: yes
